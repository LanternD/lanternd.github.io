---
layout: post
title: 和恶意代码斗争的日子
description: 从2014年11月1号开始，Google站长管理工具开始警告，说我的网站存在恶意代码，并列出了代码的可疑片段。从此吹响了我抵抗病毒的号角。
permalink: /i-hate-malware/
categories: [blog, 视·界]
tags: [恶意代码, 服务器, Google, 审核]
date: 2014-11-23
--- 

　下面这张图深刻反映了我的「奋斗」历程。现在问题解决了，网站可以正常访问了，写个日志纪念一下吧。

![1](http://lanternd.qiniudn.com/Pic4Post/fight-against-malware/no_malware_detected.jpg)

　确切来说悲剧从10月6号就开始了，那时候也很茫然，在我还不知道怎么回事，也不知道怎么解决，还没开始着手解决的时候，它自己就好了。所以根本没放在心上。而11月这次真是让我**刻骨铭心**…

　11月1号开始感染病毒，具体表现就是代码里被注入了iframe类的代码，将网页重定向一个带有病毒的网站，网页上这个框架是不可见的，要是没有防范意识的话一下就中招了。用Chrome打开的时候不会感染病毒，可能还是有一定的抗恶意代码能力，但是用IE的时候会提示有个Java程序需要加载，问是否同意运行。如果点「是」就跪了，电脑会被感染，被植入大量木马，还会产生大量占用CPU和内存资源的程序，杀毒貌似也不太容易杀干净，基本上就得重装系统。**我的笔记本就中招了**，当时也没注意到是自己网站的问题，最后给恢复了系统。感觉有点乌龙，用来管理网站的电脑中了被管理网站上的病毒……(当然，其实在一台能上网的电脑就能管理，不局限于我这台笔记本)。

　Google在检测到我的网站有恶意代码以后开始用**大红的界面**提示该网站不安全。

![2](http://lanternd.qiniudn.com/Pic4Post/fight-against-malware/red_alert.png)

　每次进自己网页的时候还得先点Details，再点visit this unsafe site。怎一个闹心了得。

　与此同时，搜索结果里也出现了提示该网站有危害的字样。

![2](http://lanternd.qiniudn.com/Pic4Post/fight-against-malware/harmful_website.jpg)

　这就好像回到自己家，发现门口站着警察守卫，必须经过他们才能进到自己的房子，**这体验太不好了**。必须解决问题！

　在这20天里面，各种链接均曾被Google提示过有恶意代码。首页，tag页面，page页面，错误模板，某一篇文章，js文件……等等。**可是，我怎么找就是没有找到任何可疑的恶意代码**！期间还用百度站长管理工具进行了错误搜索排查，没有发现问题，用过360的网页查毒，没有问题。曾一度怀疑Google报错是在瞎报错，可是连我自己都中招了，也不得不承认Google的可信度。

　新的台式机装完系统以后安装了Avast!，虽说是免费版吧，但是功能还是很强大的。用IE开这个网站的时候会直接报错并暂时屏蔽掉域名，杜绝了感染的可能性。这一点360还做不到。于是我就手持着Avast的「盾牌」开始查毒纠错之路。

　由于Google站长管理工具对网站的安全审核只能由管理员自己申请，同时是不能频繁申请的，我基本上是**每天申请一次审核的频率**。每次从申请到审查完毕大约需要3-5h。在这20天里，每次进行了改动之后就满怀希望地去申请审核，但是每次总能希望都被浇灭，这种落差挺难受的。

　由于Google只能检测到有问题，而没法准确定位病毒所在位置。我进行了各种尝试。换主题，换插件，把tag从中文全部改成英文，更换js文件，重装Wordpress等等，都不好使……是的，连重装都解决不了问题了。于是我开始觉得问题在主机提供商上，我用的是Laoxuehost上最便宜的那个美国主机，位于Los Angeles(新手嘛，挑便宜的先用着)。我把问题反馈给了他们的技术支持部门，客服倒算是挺热心，比较快响应了我的问题，但是遗憾的是他们用了多种方式搜索我的代码、文件等等，都没有发现任何问题。感觉也挺蹊跷的。

　在这20天里还有一些些小插曲，就是我所在的服务器遭遇了**两次DDOS攻击**。DDOS攻击倒不是和病毒有关系，主要是会增加服务器负担网速变慢什么的。我只是这些事情给我一种服务器不稳定不安全不可靠的感觉。

![3](http://lanternd.qiniudn.com/Pic4Post/fight-against-malware/DDOS1.jpg)

　以及：

![4](http://lanternd.qiniudn.com/Pic4Post/fight-against-malware/DDOS2.jpg)

　期间多次请JY帮忙，咨询了好多关于wp，数据库，代码，服务器，网站架构等等的问题，我觉得简直是一下从小白跳进了门 (keng)。总之是获益匪浅，在此**表示猛烈的感谢**。

　在他的提示下，我了解到管理员可以将代码托管在Sina App Engine (SAE)，Google App Engine (GAE)等网络服务上。GAE我倒是还算有点了解，GoAgent这种翻墙利器就是用GAE来实现的 (现在貌似是不好使了)。考虑到中文Blog主要面向国内用户，要是把网站部署在GAE上天天有被墙的风险，外加国内连接网速较慢，**最后考虑用SAE进行代码管理**。从11月21号开始搜集相关文章和内容，进行了相应的wp安装，数据导入，DNS解析等相关操作，由于不在本文讨论的范围就不详述了，反正最后网站终于跑起来了，时间是2014年11月22日中午12点，之后迫不及待找Google站长工具审核去了，大概下午6点的时候不再提示有新的恶意代码，8点45分收到邮件提示没有检测到任何恶意代码，如第一张图片所示。**纪念这个时刻吧**！

　到现在**我也不知道出现恶意代码的原因**，但是肯定不在我的网站文件、代码上，可能是其他人的网站出问题了波及到了我这里。Anyway，主要还是服务器空间主机不给力吧。

　一些结论：

* 百度站长工具、360站长工具都**比不上Google的站长工具**，至少在这安全这一块是这样的。
* **老薛主机 (Laoxuehost) 不靠谱**，至少便宜的不靠谱，大家慎重考虑。这个怎么说呢，便宜的多人用，人多了就容易出问题。不过服务器提供商方面没有给用户必要的安全支持还是令人遗憾。我也不是他们的同行，没有故意黑和贬低的意思，但是在我建网站刚起步的时候就遇上这种事情还是难以给出太多正面评价。
* **Avast!不错**，可以作为长期使用的杀毒&监控软件，至少现在还是深得我心的，打算长期使用。
* SAE，BAE，GAE，AWS等都有各自的特点，这种**多元化的互联网云服务平台**给用户带来了不少的便利。
* **WP的臃肿**我也能感受到一些，我打算在英文站上使用另外的Blog平台，作为对照组进行进一步的比较。

本文虽评价了各种软件、工具、服务的优劣，完全是我自己的感受，一家之言，无任何利益相关，在此声明。